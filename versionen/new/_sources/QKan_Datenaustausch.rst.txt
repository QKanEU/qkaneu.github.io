Datenaustausch
==============

Datenaustausch mit XML-Dateien
------------------------------

Für den Datenaustausch von Kanalnetzdaten existieren zwei etablierte XML-Formate. Die DWA hat mit dem Merkblatt 
DWA-M 150 "Datenaustauschformat für die Zustandserfassung von Entwässerungssystemen" im Jahr 2003 einen Standard 
herausgegeben, der seitdem in der Praxis einige kleinere Anpassungen erfahren hat, so dass insbesondere 
im Bereich der Kanalzustandserfassung mehrere Versionen existieren. Aktuell steht mit dem neuen Merkblatt DWA-M 145 
eine überarbeitete und erweiterte Version zur Verfügung, deren Einführung in der Praxis sicherlich noch einige 
Jahre in Anspruch nehmen wird. 

Der Bund hat im Jahr 2006 die erste Version des ISYBAU-XML-Austauschformates veröffentlicht, das seitdem mit den 
Versionen 2013, 2017 und 2024 mehrfach überarbeitet wurde. 

DWA-M 150
+++++++++

Das Datenaustauschformat gemäß DWA-M M150 (kurz: *M150*) umfasst je nach Bedarf Kanalstammdaten, Hausanschlussdaten 
sowie Zustandsdaten. Beim Datenimport ist zu berücksichtigen, dass QKan anstelle von Schlüsselwerten (z. B. *RW* für 
*Regenwasser*) in den Datentabellen (Haltungen, Schächte, etc.) die Langbezeichnungen verwendet. Hintergrund ist, dass 
der Anwender die Tabellen auch direkt in der QGIS-Ansicht *Attributtabellen* bearbeiten kann. 

Die Schlüsselwerte für den Datenaustausch sind in der QKan-Gruppe *Referenztabellen* zu finden. Die Schlüsselwerte 
der DWA-M 150 befinden sich in der entsprechenden Spalte. 
    
Referenztabellen
++++++++++++++++

Folgende Referenztabellen sind für den Datenimport relevant, um Schlüsselwerte aus der zu importierenden XML-Datei den entsprechenden 
Attributen von QKan zuzuordnen:

- Entwässerungsarten
- Profile
- Material
- Planungsstatus
- Wetter
- Knotenarten

Baufachliche Richtlinien Abwasser (vormals ISYBAU)
--------------------------------------------------

(Dieses Kapitel befindet sich noch in der Erstellung)


Import von Kanaldaten aus einfachen Tabellen
--------------------------------------------

Der Import von Daten aus einfachen Tabellen ist prinzipiell mit allen Methoden möglich, die QGIS zur Verfügung 
stellt. Leider funktioniert das Einfügen aus der Zwischenablage nur dann, wenn alle Attribute einer Tabelle 
einschließlich der Geometrieattribute vorhanden sind, die Namen exakt mit denen der Tabelle übereinstimmen 
und in der gleichen Reihenfolge stehen. Da dies nicht besonders praktikabel ist, wurde in QKan eine 
intelligente Clipboard-Einfügefunktion implementiert. 

Die Bedienung ist denkbar einfach: Um Daten mit Copy&Paste aus einer Tabelle (Excel, Textdatei, 
ACCESS-Datenbank, etc.) einzufügen, muss der entsprechende Layer in der Layerkontrolle aktiviert sein. Er darf 
sich dabei nicht im Bearbeitungsmodus befinden. Dabei gelten folgende Anforderungen: 

 - bestimmte Pflichtattribute müssen vorhanden sein
 - Die Reihenfolge der Daten ist beliebig
 - Für die meisten Attributnamen werden zahlreiche Synonyme akzeptiert (z. B. "schnam", "schachtname" oder 
   "Schachtbezeichnung"). Die Synonyme werden anhand vorgegebener "regulärer Ausdrücke" den Attributnamen der 
   QKan-Tabellen zugeordnet, die gegebenenfalls erweitert werden können. 

Zum Einfügen der Daten muss nur noch |Tool_clipboard_einfuegen| :guilabel:`Tabellendaten aus Clipboard einfügen` angeklickt werden.

.. |Tool_clipboard_einfuegen| image:: ./QKan_Bilder/Tool_clipboard_einfügen.png
                             :width: 1.25 em

Um vorab zu überprüfen, welche Spaltennamen erkannt werden, kann zuvor |Tool_clipboard_zuordnung| :guilabel:`Tabellen aus Clipboard: Zuordnung anzeigen`
angeklickt werden.

.. |Tool_clipboard_zuordnung| image:: ./QKan_Bilder/Tool_clipboard_zuordnung.png
                             :width: 1.25 em

Bei Tabellen mit Geometrien (Schächte, Haltungen, Fläche, etc.) werden in den Fällen, wo Punktkoordinaten 
oder Paare davon ausreichen (z. B. Schächte: Punktkoordinate, Haltungen und Wehre: 2 Punktkoordinaten für 
Anfangs- und Endpunkt) diese aus den eingefügten Koordinatenwerten erzeugt. 

Es ist aber auch möglich, Geometrien als WKT-Text einzufügen. Die Schreibweise entspricht der von QGIS, 
wenn Datensätze mit Geometrien kopiert und in eine Textdatei eingefügt werden. 

Beispiel zum Ausprobieren: 

| 1. Leere QKan-Datenbank anlegen (Schaltfläche "Neue QKan-Datenbank erstellen")

| 2. Schachtdaten (in Layer "Schächte" einfügen):
|
| Schacht;x;y;Sohle;Deckel                   
| D110076;388809.4738;5709888.006;80.49;83.61
| D110077;388806.8219;5709900.202;80.34;83.71
| D110075;388813.9783;5709854.593;81.16;84.09
| D110073;388749.989;5709812.893;82.77;85.47
| D110074;388709.6162;5709930.665;80.82;83.49
| D110801;388806.4423;5709907.041;80.22;83.28
| D110036;388798.8302;5709945.165;79.51;82.56
| D119801;388784.1633;5709985.519;78.84;81.86

| 3. Haltungsdaten (in Layer "Haltungen" einfügen): 
|
| Haltung;Schacht_oben;Schacht_unten;Höhe;Breite;Länge;Sohleoben;Sohleunten;Profilname
| 410;D110076;D110077;0.3;0.3;12.55;80.5;80.32;Kreisquerschnitt
| 409;D110075;D110076;0.3;0.3;34.04;81.16;80.52;Kreisquerschnitt
| 408;D110073;D110074;0.2;0.2;124.28;82.8;80.85;Kreisquerschnitt
| 407;D110801;D110036;0.3;0.3;40.14;80.2;79.49;Kreisquerschnitt
| 443;D110036;D119801;0.3;0.3;42.4;79.49;78.88;Kreisquerschnitt
| 1364;D110077;D110801;0.3;0.3;5.5;80.3;80.2;Kreisquerschnitt


.. image:: ./QKan_Bilder/netz_aus_clipboard.png

Abbildung: Eingefügtes Kanalnetz in QKan
